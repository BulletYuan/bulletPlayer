<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>bulletPlayer-demo</title>

    <style>
    *{ margin: 0; padding: 0;}
    </style>
    <link href="./bulletPlayer.css" rel="stylesheet" />
</head>
<body>
    <video data-bulletPlayer src="http://www.w3school.com.cn/i/movie.ogg"></video>
    <div data-bulletPlayer class="playerContainer-bullet">
        <div class="titleBar">
            <p class="titleText">title...</p>
        </div>
        <canvas></canvas>
        <div class="controlBar">
            <div class="progressBar">
                <div class="buffBar"></div>
                <div class="playedBar"></div>
                <div class="handle"></div>
            </div>
            <div class="toolBar">
                <div class="leftBar">
                    <div class="playBtn">play</div>
                </div>
                <div class="rightBar"></div>
            </div>
        </div>
    </div>
</body>
<script>
    let video_bullet={
        ctx:null,
        cav:null,
        con:null,
        video:null,

        height:0,
        width:0,
        quality:1,
        playSrc:"",
        volume:1,  //音量 0~1

        _buffered:0,  //已缓冲比例 0~1
        _played:0,  //已播放比例 0~1
        _current:0,  //当前所在时间点 单位s
        _duration:0,  //视频总时长 单位s
        _fullScreen:0,  //0:非全屏 | 1:全屏 | -1:浏览器不支持全屏
        _autoPlay:false,  //自动播放
        _loop:false,  //循环播放c
        _netState:0,  //0:NETWORK_EMPTY | 1:NETWORK_IDLE | 2:NETWORK_LOADING | 3:NETWORK_NO_SOURCE
        _status:0,  //0:ended | 1:play | 2:pause | -1:error
        _interval:null,

        playVideo:function(){
            if(!this.video) return false;
            this.video.play();
        },
        pauseVideo:function(){
            if(!this.video) return false;
            this.video.pause();
        },
        setVolume:function(vol=0){
            if(!this.video) return false;
            this.video.volume=vol;
            this.volume=vol;
            return this.volume;
        },
        fullScreen:function(){
            if(!this.video) return false;
            if(document.webkitFullscreenEnabled&&document.webkitCurrentFullScreenElement){
                let that=this;
                document.webkitCurrentFullScreenElement.forEach(el=>{
                    if(el!=that.video)  el.webkitExitFullScreen();
                });
                if(!this.video.webkitDisplayingFullscreen)  this.video.webkitEnterFullScreen();
            }
        },
        
        initVideo:function(el,con){
            this.con=con,
            this.video=el,
            this.cav=con.querySelector('canvas');
            this.ctx=this.cav.getContext('2d');

            this._initParams();

            this._bindPlay();
            this._bindPause();
            this._bindEnded();
            this._bindHandlerDrag();
            
            this.video.addEventListener('loadeddata',()=>{
                this.refreshParams();
                this.refreshUI();
                this._initSize();
            },false);
            window.addEventListener('resize',()=>{
                this._initSize();
                this.refreshUI();
            },false);
        },

        _initSize:function(){
            if(!this.video||!this.con||!this.cav) return false;
            let _w2h=0;  //视频画面宽高比
            this.quality=this.quality>1?1:this.quality;
            let vw=this.video.videoWidth,vh=this.video.videoWidth;
            if(vh>=this.con.clientHeight){
                _w2h=vw/vh;
                this.height=this.con.clientHeight;
                this.width=this.height*_w2h;
            }else{
                this.height=vh;
                _w2h=vw/vh;
                this.width=this.height*_w2h;
            }
            this.cav.width=this.width*this.quality;
            this.cav.height=this.cav.width/_w2h;
        },
        _initParams:function(){
            if(!this.video) return false;
            this.playSrc=this.video.currentSrc;
            this.video.volume=this.volume;
            this.video.autoPlay=this._autoPlay;
            this.video.loop=this._loop;
            this.video.controls=false;
        },
        refreshParams:function(){
            if(!this.video) return false;
            let v=this.video;

            this._duration=v.duration;
            this._current=v.currentTime;
            this._buffered=v.buffered.length>0?v.buffered.end(v.buffered.length-1)/this._duration:0;
            this._played=this._current/this._duration;
            this._netState=v.networkState;
            this._autoPlay=v.autoplay;
            this._loop=v.loop;
            if(!document.webkitFullscreenEnabled)  this._fullScreen=-1;

            if(v.ended)  this._status=0;
            if(v.played)  this._status=1;
            if(v.paused)  this._status=2;
            if(v.error)  this._status=-1;
        },
        refreshUI:function(){
            if(!this.video||!this.con) return false;
            if(this._status===0 || this._status===-1)  this._resetCav();
            if(this._status===1)  this._drawCav();
            if(this._status===2)  this._stopCav();
            let buffBar=this.con.querySelector('.buffBar'),
                playedBar=this.con.querySelector('.playedBar'),
                handle=this.con.querySelector('.handle');
            if(buffBar)  buffBar.style.width=(this._buffered*100)+"%";
            if(playedBar)  playedBar.style.width=(this._played*100)+"%";
            if(handle)  handle.style.left=(this._played*this.con.clientWidth-handle.clientWidth/2)+"px";
        },

        _bindHandlerDrag:function(){
            if(!this.con)   return false;
            let handle=this.con.querySelector('.handle'),
             self=this,_dragState=2;  //0:touchstart/mousedown | 1:touchmove/mousemove |2:touchend/mouseup
             
            if(window.ontouchstart){
                handle.ontouchstart=function(ev){
                    _dragState=0;
                    document.ontouchmove=function(ev){
                        _dragState=1;
                        handle.style.left=(ev.clientX-handle.clientWidth/2)+'px';
                        self.video.currentTime=(ev.clientX/self.con.clientWidth)*self.video.duration;
                    };
                    document.ontouchend=function(){
                        _dragState=2;
                        document.onmousemove=null;
                        document.onmouseup=null;
                    };
                };
            }else{
                handle.onmousedown=function(ev){
                    _dragState=0;
                    document.onmousemove=function(ev){
                        _dragState=1;
                        handle.style.left=(ev.clientX-handle.clientWidth/2)+'px';
                        self.video.currentTime=(ev.clientX/self.con.clientWidth)*self.video.duration;
                    };
                    document.onmouseup=function(){
                        _dragState=2;
                        document.onmousemove=null;
                        document.onmouseup=null;
                    };
                };
            }
        },

        _bindPlay:function(){
            if(!this.video||!this.con)   return false;
            let self=this;
            let play=this.con.querySelector('.playBtn');
            play.onclick=()=>{
                if(self._status===0||self._status===2)  self.playVideo();
                if(self._status===1)  self.pauseVideo();
            };
            this.video.addEventListener('play',function(){
                self._status=1;
                self._interval=setInterval(()=>{
                    self.refreshParams();
                    self.refreshUI();
                },100)
            },false);
        },
        _bindPause:function(){
            if(!this.video)   return false;
            let self=this;
            self._interval=null;
            this.video.addEventListener('pause',function(){
                self._status=2;
                self.refreshParams();
                self.refreshUI();
            },false);
        },
        _bindEnded:function(){
            if(!this.video)   return false;
            let self=this;
            self._interval=null;
            this.video.addEventListener('ended',function(){
                self._status=1;
                self.refreshParams();
                self.refreshUI();
            },false);
        },

        _drawCav:function(){
            if(!this.ctx)   return false;
            let self=this;
            if(this._status!==1)    return false;
            setTimeout(()=>{self.ctx.drawImage(self.video,0,0,self.width,self.height)},10);
        },
        _stopCav:function(){
            if(!this.ctx)   return false;
            let self=this;
            setTimeout(()=>{self.ctx.drawImage(self.video,0,0,self.width,self.height)},10);
        },
        _resetCav:function(){}
    };
</script>
<script>
    
    let videoArr=document.querySelectorAll('video[data-bulletPlayer]'),
    containerArr=document.querySelectorAll('.playerContainer-bullet[data-bulletPlayer]');
    videoArr.forEach((el,i) => {
        video_bullet.initVideo(el,containerArr[i]);
    });

    // let videoDomArr=[];
    // videoDomArr=document.querySelectorAll('video[data-bulletPlayer]');
    // console.log(videoDomArr);

    // let videoDom=videoDomArr[0],
    //     playerDom;
    // videoDom.parentNode.insertBefore(videoDom,playerDom);
</script>
</html>